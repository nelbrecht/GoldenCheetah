From e1f42f8b3340eb4695ad73be764332e75b7bce90 Mon Sep 17 00:00:00 2001
From: Poncho <poncho@spahan.ch>
Date: Mon, 7 Sep 2020 09:39:49 +0200
Subject: [PATCH 1/2] Fix building with bison 3.7

Bison 3.7 changes how header files are included [1][2], in that instead of
copying and inserting the contents of a file, the file itself is included
(by default as '"basename.h"').

[1] https://lists.gnu.org/archive/html/info-gnu/2020-07/msg00006.html
[2] https://www.gnu.org/software/bison/manual/html_node/_0025define-Summary.html

Close: https://github.com/GoldenCheetah/GoldenCheetah/issues/3586
---
 src/Core/DataFilter.y     | 3 +++
 src/Core/RideDB.y         | 2 ++
 src/FileIO/JsonRideFile.y | 3 +++
 3 files changed, 8 insertions(+)

diff --git a/src/Core/DataFilter.y b/src/Core/DataFilter.y
index c532c06ee2..3d4e914ee3 100644
--- a/src/Core/DataFilter.y
+++ b/src/Core/DataFilter.y
@@ -49,6 +49,9 @@ extern Leaf *DataFilterroot; // root node for parsed statement
 
 %}
 
+// generated by the scanner
+%define api.header.include {"DataFilter_yacc.h"}
+
 // Symbol can be meta or metric name
 %token <leaf> SYMBOL PYTHON
 
diff --git a/src/Core/RideDB.y b/src/Core/RideDB.y
index e2b63cc0dd..86f8a2ec94 100644
--- a/src/Core/RideDB.y
+++ b/src/Core/RideDB.y
@@ -40,6 +40,8 @@ void RideDBerror(void*jc, const char *error) // used by parser aka yyerror()
 #define scanner jc->scanner
 
 %}
+// generated by the scanner
+%define api.header.include {"RideDB_yacc.h"}
 
 %pure-parser
 %lex-param { void *scanner }
diff --git a/src/FileIO/JsonRideFile.y b/src/FileIO/JsonRideFile.y
index 2cbbef9fc8..d5c77a779d 100644
--- a/src/FileIO/JsonRideFile.y
+++ b/src/FileIO/JsonRideFile.y
@@ -106,6 +106,9 @@ static QString protect(const QString string)
 
 %}
 
+// generated by the scanner
+%define api.header.include {"JsonRideFile_yacc.h"}
+
 %pure-parser
 %lex-param { void *scanner }
 %parse-param { struct JsonContext *jc }

From 94f99aa48cc0ebfc94e96498772663c26fa7128a Mon Sep 17 00:00:00 2001
From: Poncho <poncho@spahan.ch>
Date: Sun, 11 Oct 2020 11:27:43 +0200
Subject: [PATCH 2/2] require >=bison-3.4

Unfortunately, the "%define api.header.include" synthax is not compatible with
older versions of bison [1]

[1] https://lists.gnu.org/archive/html/bug-bison/2020-08/msg00014.html
[skip travis] [skip appveyor]
---
 src/Core/DataFilter.y     | 1 +
 src/Core/RideDB.y         | 2 ++
 src/FileIO/JsonRideFile.y | 1 +
 3 files changed, 4 insertions(+)

diff --git a/src/Core/DataFilter.y b/src/Core/DataFilter.y
index 3d4e914ee3..08f1716a65 100644
--- a/src/Core/DataFilter.y
+++ b/src/Core/DataFilter.y
@@ -49,6 +49,7 @@ extern Leaf *DataFilterroot; // root node for parsed statement
 
 %}
 
+%require "3.4"
 // generated by the scanner
 %define api.header.include {"DataFilter_yacc.h"}
 
diff --git a/src/Core/RideDB.y b/src/Core/RideDB.y
index 86f8a2ec94..7427e36062 100644
--- a/src/Core/RideDB.y
+++ b/src/Core/RideDB.y
@@ -40,6 +40,8 @@ void RideDBerror(void*jc, const char *error) // used by parser aka yyerror()
 #define scanner jc->scanner
 
 %}
+
+%require "3.4"
 // generated by the scanner
 %define api.header.include {"RideDB_yacc.h"}
 
diff --git a/src/FileIO/JsonRideFile.y b/src/FileIO/JsonRideFile.y
index d5c77a779d..c5e6b8e774 100644
--- a/src/FileIO/JsonRideFile.y
+++ b/src/FileIO/JsonRideFile.y
@@ -106,6 +106,7 @@ static QString protect(const QString string)
 
 %}
 
+%require "3.4"
 // generated by the scanner
 %define api.header.include {"JsonRideFile_yacc.h"}
 
